<div ng-if="vm.isLoading" layout="row" layout-align="center center" class="loading-circle">
  <md-progress-circular class="md-accent" md-diameter="100px"></md-progress-circular>
</div>

<section 
  ng-show="!vm.isLoading" 
  class="form-view container container-xlg quotation-view"
>

  <h1><i class="icon-attachment"></i> <strong>OPORTUNIDAD #{{vm.quotation.folio}}</strong></h1>
  <hr/>


  <section class="quotation-data">
    <div>
      <label>Status</label>
      <p>
        <span 
          ng-class="{
            'active': !vm.quotation.Order,
            'closed': vm.quotation.Order
          }">
          {{vm.status}}
        </span>
        <a
          class="order-link"
          ng-href="/checkout/order/{{vm.quotation.Order.id}}"
          ng-if="vm.quotation.Order">
          | Haz click aqui para ver el pedido
        </a>
      </p>
    </div>
    <div layout="row" class="quotation-data-row">
      <div flex="25">
        <label for="">Nombre del cliente</label>
        <p>{{vm.quotation.Client.CardName || 'Sin cliente asignado'}}</p>
      </div>
      <div flex="25">
        <label for="">Fecha de cotización</label>
        <p>{{vm.quotation.createdAt | date: 'd/MMM/yyyy'}}</p>
      </div>
      <div flex="25">
        <label for="">Vendedor</label>
        <p>{{vm.quotation.User.firstName + ' ' + vm.quotation.User.lastName}}</p>
      </div>
      <div flex="25">
        <p><label for="">Broker</label></p>
        <select
          chosen
          data-placeholder-text-single="'Seleccionar un broker'"
          ng-model="vm.quotation.Broker"
          ng-options="broker.id as broker.firstName + ' ' + broker.lastName for broker in vm.brokers | orderBy:'firstName'"
        >
        </select>

      </div>
    </div>

    <div layout="row" layout-align="start center" class="quotation-data-row">
      <div flex="25">
        <label for="">Télefono fijo</label>
        <p>{{vm.quotation.Client.Phone1 || 'No proporcionado'}}</p>
      </div>
      <div flex="25">
        <label for="">Télefono celular</label>
        <p>{{vm.quotation.Client.Cellular || 'No proporcionado'}}</p>
      </div>
      <div flex="25">
        <label for="">E-mail</label>
        <p>{{vm.quotation.Client.E_Mail || 'No proporcionado'}}</p>
      </div>
    </div>

  </section>

  <form 
    ng-submit="vm.continueBuying()" 
    class="cart-view container container-xxlg" 
  >

    <div layout="row" layout-align="space-between start">

      <section flex="70" class="cart-list">
        <h1 class="cart-title"><strong>ARTICULOS AGREGADOS</strong></h1>
        <div ng-if="vm.isLoadingDetails" layout="row" layout-align="center center" class="loading-circle">
          <md-progress-circular class="md-accent" md-diameter="100px"></md-progress-circular>
        </div>

        <div ng-if="!vm.isLoadingDetails" class="cart-items">
          <ng-include 
            class="cart-item-wrapper"
            ng-repeat="detailGroup in vm.quotation.DetailsGroups track by $index" 
            src="'views/partials/product-cart-item.html'"></ng-include>    
        </div>

        <a
          href="#"
          ng-if="!vm.quotation.Order && !vm.quotation.isClosed"
          ng-click="vm.addNewProduct()"
          class="action-btn print-btn">
          AGREGAR NUEVO ARTÍCULO
        </a>

      </section>

      <aside flex class="cart-aside">
        <h1 class="cart-title"><i class="icon-carro"><span>{{ vm.quotation.totalProducts }}</span></i> <strong>MI CARRITO</strong></h1>

        <div class="cart-summary">
          <table>
            <tr>
              <td><strong>Subtotal ({{ vm.quotation.totalProducts }} productos):</strong></td>
              <td><strong>{{ vm.quotation.subtotal | currency }}</strong></td>
            </tr>
            <tr>
              <td>Descuento:</td>
              <td><strong>{{ vm.quotation.discount | currency }}</strong></td>
            </tr>
            <tr>
              <td>Costo de envío:</td>
              <td><strong>GRATIS</strong></td>
            </tr>
          </table>
          <hr>

          <div class="cart-totals" layout="row" layout-align="space-between end">
            <div flex="30">
              <h1><strong>TOTAL:</strong></h1>
            </div>
            <div flex="70">
              <h3 class="price-crossed" ng-show="vm.quotation.subtotal != vm.quotation.total">
                {{ vm.quotation.subtotal | roundCurrency  }}
              </h3>
              <h1 class="price-main">{{ vm.quotation.total | roundCurrency  }}</h1>
            </div>
          </div>

          <input
            type="submit"
            value="CONTINUAR"
            ng-if="!vm.quotation.Order && !vm.quotation.isClosed && vm.quotation.Client"
            ng-disabled="!vm.isValidStock(vm.quotation.Details)"
            ng-class="{'cart-view-btn-disabled' : !vm.isValidStock(vm.quotation.Details) }"
            class="cart-view-btn print-btn"
          >

          <input
            type="submit"
            value="ASIGNAR CLIENTE"
            ng-disabled="!vm.isValidStock(vm.quotation.Details)"
            ng-if="!vm.quotation.Order && !vm.quotation.isClosed && !vm.quotation.Client"
            ng-class="{'cart-view-btn-disabled' : !vm.isValidStock(vm.quotation.Details) }"
            class="cart-view-btn print-btn"
          >

          <p class="cart-summary-note" ng-if="!vm.quotation.Client">
            A continuación puedes elegir un cliente o asignar un nuevo cliente
          </p>

          <p class="cart-summary-note" ng-if="vm.quotation.Client">
            *Precios en Pesos Mexicanos con impuestos incluidos.
          </p>

        </div>

        <a
          ng-if="vm.quotation.Client"
          href="#"
          ng-click="vm.print()"
          class="action-btn print-btn">
          IMPRIMIR
        </a>

        <a
          ng-if="vm.quotation.Client"
          ng-click="vm.sendByEmail()"
          href="#"
          class="action-btn">
          ENVIAR POR EMAIL
        </a>

      </aside>

    </div>

  </form>

  <ng-include 
    src="'views/quotations/transfers-table.html'"></ng-include>    

  <ng-include 
    src="'views/quotations/quotation-records.html'"></ng-include>    

  <ng-include src="'views/quotations/quotation-texts.html'"></ng-include>

</section>
